<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>出荷検査成績書オークマ専用MB46V</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* ========== GLOBAL ========== */
    html, body {
      background: #e7e7e7;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      font-size: 3.5mm;
      height: 100%;
    }

    /* ========== CENTER DI LAYAR ========== */
    @media screen {
      html, body {
        display: flex;
        flex-direction: column; /* supaya scroll vertikal normal */
        align-items: center;    /* center kiri-kanan */
      }
      .b5-preview {
        margin: 10mm 0;         /* jarak atas-bawah */
      }
    }

    /* ========== PREVIEW BOX ========== */
    .b5-preview { background:#fff; width:176mm; max-width:98vw; margin:10mm auto; padding:8mm; box-shadow:0 0 5mm #bbb; box-sizing:border-box; }
    h2 { text-align:center; margin:0 0 4mm; }
    

    h2 {
      text-align: center;
      font-size: 7mm;
      margin-bottom: 8mm;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 4mm;
    }
    th, td {
      border: 0.3mm solid #333;
      padding: 1.2mm 1mm;
      text-align: center;
      background: #fff;
    }
    th { background: #f0f0f0; }
    .section-label {
      text-align: left;
      font-weight: bold;
      background: #f9f9f9;
    }
    input, select {
      font-size: 3.5mm;
      padding: 0.5mm;
      box-sizing: border-box;
    }
    .button {
      margin: 3mm 1mm 0 0;
      padding: 2mm 8mm;
      font-size: 3.5mm;
    }
    .td-measure { padding: 0!important; }
    .td-measure-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 1mm;
    }
    .td-measure-grid input {
      text-align: right;
      border: none;
      background: none;
    }
    .td-measure-grid input:invalid,
    .td-measure-grid input.invalid {
      border: 0.3mm solid red !important;
      background-color: #ffe6e6;
      color: red !important;
    }
    .inputter-row {
      display: flex;
      align-items: center;
      gap: 2mm;
      margin-bottom: 3mm;
    }
    .inputter-row label { width: 12mm; font-weight: bold; }
    .inputter-row select { width: 30%; }

    /* ========== SIGNATURE BOX DENGAN LABEL DI DALAM ========== */
    .stamp-box-row {
      display: flex;
      justify-content: flex-end;
      gap: 4mm;
      margin-top: 3mm;
    }
    .stamp-box-row > div {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .signature-box {
      position: relative;
      width: 15mm;
      height: 15mm;
      border: 0.3mm solid #333;
      border-radius: 2mm;
      background: #fafbfc;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .signature-box::before {
      content: attr(data-label);
      position: absolute;
      top: 1mm;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 3mm;
      pointer-events: none;
    }
    .signature-box img {
      width: 9mm;
      height: 9mm;
      object-fit: contain;
    }

    .company-name {
      text-align: right;
      margin: 2mm 1mm 0;
      font-weight: bold;
    }
    .order-no-row .section-label { width: 15%; }
    .order-no-row .data { width: 85%; }

    /* ========== PRINT STYLES ========== */
    @media print {
      @page { size: B5 portrait; margin: 0; }
      html, body {
        background: none!important;
        margin: auto!important;
        padding: 0!important;
        height: auto!important;
      }
      .b5-preview {
        width: 98%;
        height: 98%;
        margin: auto;
        padding: 0;
        box-shadow: none;
      }
      .button, .inputter-row, select.no-print { display: none!important; }
      input {
        border: none;
        background: none;
        padding: 0;
        font-size: 3.5mm;
      }
      .signature-box img[src=""] { display: none!important; }
      .stamp-box-row, .signature-box { display: flex!important; }
      .print-text { display: inline; }
      .stamp-box-row .print-text { display: none!important; }
       .stamp-box-row .print-text {
      display: none !important;
    }
    }
  </style>
</head>
<body>
  <form id="inspection-form">
    <div class="b5-preview">
      <h2>出荷検査成績書</h2>

      <!-- HEADER TABLE -->
      <table>
        <tr>
          <td class="section-label">客先</td><td style="width:20%;">オークマ株式会社</td>
          <td class="section-label">発行NO.</td><td><input type="text" name="customer_no" placeholder="例: TTS60-01-460"></td>
          <td class="section-label">発行年月日</td><td><input type="date" name="hakkohiduke"></td>
        </tr>
        <tr>
          <td class="section-label">機種</td><td>MB-46V</td>
          <td class="section-label">品番</td><td><input type="text" name="part_no" placeholder="例: H1090-0021-02-5"></td>
          <td class="section-label">図番</td><td>2825-20</td>
        </tr>
        <tr>
          <td class="section-label">品名</td><td>Y軸SG</td>
          <td class="section-label">製造日</td><td><input type="date" name="makingdate"></td>
          <td class="section-label">製造NO</td><td><input type="text" name="serial_no" placeholder="例: Y282520-2245"></td>
        </tr>
        <tr class="order-no-row">
          <td class="section-label">オーダーNo</td>
          <td class="data" colspan="5"><input type="text" name="order_no" placeholder="例: 102P068219-001"></td>
        </tr>
      </table>

      <!-- INPUTTER -->
      <div class="inputter-row">
        <label>入力者</label>
        <select name="inputter">
          <option value="">- 選択してください -</option>
          <option value="長谷部">長谷部</option>
          <option value="都合">都合</option>
          <option value="石橋">石橋</option>
        </select>
      </div>

      <!-- INSPECTION ITEMS -->
      <table>
        <tr><th>検査項目</th><th>規格</th><th>判定</th></tr>
        <tr>
          <td>本体取付け方法</td><td>組立架台取付合わせ確認</td>
          <td>
            <select name="judge1" class="no-print"><option>合</option><option>否</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
        <tr>
          <td>摺動テスト</td><td>摺動テスト台走り・機能確認</td>
          <td>
            <select name="judge2" class="no-print"><option>合</option><option>否</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
        <tr>
          <td>摺動時の異音</td><td>異音の有無確認</td>
          <td>
            <select name="judge3" class="no-print"><option>無</option><option>有</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
        <tr>
          <td>外観検査</td><td>キズ・バリの有無確認</td>
          <td>
            <select name="judge4" class="no-print"><option>合</option><option>否</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
        <tr>
          <td>カバーワイパーの除隅</td><td>ワイパー材 t=0.05にて確認</td>
          <td>
            <select name="judge5" class="no-print"><option>合</option><option>否</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
      </table>

      <!-- MEASUREMENTS -->
      <table>
        <tr><th>項目</th><th>基準値</th><th>測定値</th></tr>
        <tr>
          <td>収縮時長さ(a)</td>
          <td>190 mm以下</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="number" name="a_length" placeholder="0-190" min="0" max="190" data-min="0" data-max="190">
              <span>mm</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>伸長時長さ(b)</td>
          <td>670 mm以上</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="number" name="b_length" placeholder=">=670" min="670" data-min="670">
              <span>mm</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>カバーストローク(s)</td>
          <td>480 mm以上</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="number" name="c_length" placeholder=">=480" min="480" data-min="480">
              <span>mm</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>初期摺動抵抗</td>
          <td>0 - 4.0 kg</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="number" step="0.1" name="start_resist" placeholder="0-4.0" min="0" max="4" data-min="0" data-max="4">
              <span>kg</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>中期摺動抵抗</td>
          <td>0 - 4.0 kg</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="number" step="0.1" name="mid_resist" placeholder="0-4.0" min="0" max="4" data-min="0" data-max="4">
              <span>kg</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>終期摺動抵抗</td>
          <td>0 - 4.0 kg</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="number" step="0.1" name="end_resist" placeholder="0-4.0" min="0" max="4" data-min="0" data-max="4">
              <span>kg</span>
            </div>
          </td>
        </tr>
      </table>

      <!-- FINAL JUDGMENT & REMARKS -->
      <div style="margin:2mm 0;">
        <label style="font-weight:bold;">総合判定</label>
        <select name="final_judgment" class="no-print" style="margin-left:10mm;">
          <option>合</option><option>否</option>
        </select>
        <span class="print-text"></span>
      </div>
      <div style="margin:2mm 0;">
        <label style="font-weight:bold;">[備考]</label>
        <input type="text" name="bikou" style="width:70%;">
      </div>

      <!-- BUTTONS -->
      <button type="button" class="button" onclick="window.print()">印刷</button>
      <button type="button" class="button" onclick="saveAsPDF()">PDF保存</button>
      <button type="button" class="button" id="clearAllBtn">全クリア</button>

      <!-- COMPANY & STAMPS -->
      <div class="company-name">東京精密発條株式会社</div>
      <div class="stamp-box-row">
        <div>
          <select class="no-print" onchange="updateStampPreview('stamp1',this.value)">
            <option value="">- 印鑑選択 -</option>
            <option value="nakagawa.png">中川部長</option>
            <option value="hasebe.png">長谷部</option>
            <option value="ishibashi.png">石橋</option>
          </select>
          <div class="signature-box" data-label="検印">
            <img id="stamp1" src="" alt="">
          </div>
        </div>
        <div>
          <select class="no-print" onchange="updateStampPreview('stamp2',this.value)">
            <option value="">- 印鑑選択 -</option>
            <option value="hasebe.png">長谷部</option>
            <option value="togo.png">都合</option>
            <option value="ishibashi.png">石橋</option>
            <option value="wahyu.png">ワーユ</option>
            <option value="yusuf.png">ユスフ</option>
          </select>
          <div class="signature-box" data-label="検査印">
            <img id="stamp2" src="" alt="">
          </div>
        </div>
      </div>
    </div>
  </form>

  <script>
    function updateStampPreview(id, src) {
      document.getElementById(id).src = src || '';
    }
    function clearAllFields() {
      document.getElementById('inspection-form').reset();
      ['stamp1','stamp2'].forEach(id => document.getElementById(id).src = '');
    }
    document.getElementById('clearAllBtn').addEventListener('click', clearAllFields);

    document.querySelectorAll('.td-measure-grid input').forEach(input => {
      let lastValid = input.value;
      input.addEventListener('input', () => {
        const val = parseFloat(input.value);
        const min = parseFloat(input.dataset.min ?? -Infinity);
        const max = parseFloat(input.dataset.max ?? Infinity);
        if (!isNaN(val) && val >= min && val <= max) {
          lastValid = input.value;
          input.classList.remove('invalid');
        }
      });
      input.addEventListener('blur', () => {
        const val = parseFloat(input.value);
        const min = parseFloat(input.dataset.min ?? -Infinity);
        const max = parseFloat(input.dataset.max ?? Infinity);
        if (!isNaN(val) && (val < min || val > max)) {
          input.value = lastValid;
        }
      });
    });

    async function saveAsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'b5' });
      const el = document.querySelector('.b5-preview');
      let makingDate = document.querySelector('input[name="makingdate"]').value;
      let ymd = makingDate
        ? makingDate.replace(/-/g,'')
        : (() => {
            const t = new Date();
            return t.getFullYear().toString()
              + String(t.getMonth()+1).padStart(2,'0')
              + String(t.getDate()).padStart(2,'0');
          })();
      const inputter = (document.querySelector('select[name="inputter"]').value || 'no-name')
        .replace(/[\\/:*?"<>|]/g,'');
      const orderNo = (document.querySelector('input[name="order_no"]').value || 'no-order')
        .replace(/[\\/:*?"<>|]/g,'');
      const serialNo = (document.querySelector('input[name="serial_no"]').value || 'no-serial')
        .replace(/[\\/:*?"<>|]/g,'');
      await html2canvas(el, { scale:2, ignoreElements: e => e.classList.contains('no-print') })
        .then(canvas => {
          doc.addImage(canvas.toDataURL(), 'PNG', 0, 0, 176, 250);
          doc.save(`${ymd}_${inputter}_${orderNo}_${serialNo}.pdf`);
        });
    }

    window.addEventListener('load', () => {
      document.querySelectorAll('select.no-print').forEach(sel => {
        const span = document.createElement('span');
        span.className = 'print-text';
        sel.parentNode.insertBefore(span, sel.nextSibling);
        const upd = () => span.textContent = sel.value;
        sel.addEventListener('change', upd);
        upd();
      });
    });
  </script>
</body>
</html>

