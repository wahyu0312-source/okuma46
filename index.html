<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>出荷検査成績書オークマ専用MB46V</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* ======= GLOBAL ======= */
    html, body { background:#e7e7e7; margin:0; padding:0; font-family:Arial,sans-serif; font-size:3.5mm; height:100%; }
    .no-print { display: initial; } .print-text { display: none; }

    /* Konsistensi font (termasuk date) */
    input, select { font-size:3.2mm; padding:.5mm; box-sizing:border-box; font-family:Arial,sans-serif; }
    input[type="date"] { -webkit-appearance:none; appearance:none; line-height:1.2; }

    /* Hilangkan border input tabel */
    table input, table input[type="date"], .td-measure-grid input {
      border:none; outline:none; background:transparent; box-shadow:none; border-radius:0;
      padding:0 1mm; width:100%; height:100%; box-sizing:border-box; -webkit-appearance:none; appearance:none;
    }
    table input:focus, table input[type="date"]:focus { outline:none; box-shadow:none; }

    /* ======= SCREEN LAYOUT ======= */
    @media screen { html, body { display:flex; flex-direction:column; align-items:center; } .b5-preview { margin:12mm 0; } }
    .b5-preview { background:#fff; width:176mm; max-width:98vw; margin:10mm auto; padding:8mm; box-shadow:0 0 5mm rgba(0,0,0,.25); box-sizing:border-box; }

    h2 { text-align:center; font-size:7mm; margin-bottom:8mm; }

    table { width:100%; border-collapse:collapse; margin-bottom:4mm; }
    th, td { border:.3mm solid #333; padding:1.2mm 1mm; text-align:center; background:#fff; vertical-align:middle; }
    th { background:#f0f0f0; }
    .section-label { text-align:left; font-weight:bold; background:#f9f9f9; }

    .header-table td, .header-table th { white-space:nowrap; word-break:keep-all; }
    .header-table input { min-width:0; }

    .button { margin:3mm 1mm 0 0; padding:2mm 8mm; font-size:3.5mm; }

    .td-measure { padding:0 !important; }
    .td-measure-grid { display:grid; grid-template-columns:1fr auto; align-items:center; gap:1mm; }
    .td-measure-grid input { text-align:right; }

    .inputter-row { display:flex; align-items:center; gap:2mm; margin-bottom:3mm; }
    .inputter-row label { width:12mm; font-weight:bold; }
    .inputter-row select { width:30%; }

    /* ======= STAMPS ======= */
    .stamp-box-row { display:flex; justify-content:flex-end; gap:4mm; margin-top:3mm; }
    .stamp-box-row>div { display:flex; flex-direction:column; align-items:center; }
    .stamp-label { font-size:3mm; margin-bottom:1mm; text-align:center; }
    .signature-box { width:15mm; height:15mm; border:.3mm solid #333; border-radius:2mm; background:#fafbfc; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .signature-box img { width:9mm; height:9mm; object-fit:contain; }

    .company-name { text-align:right; margin:2mm 1mm 0; font-weight:bold; }
    .order-no-row .section-label { width:15%; } .order-no-row .data { width:85%; }

    /* ======= FLOATING TOOLBAR ======= */
    .toolbar {
      position:fixed; top:12px; left:50%; transform:translateX(-50%);
      display:flex; gap:8px; padding:8px 10px; background:rgba(255,255,255,0.92);
      border:1px solid #ddd; border-radius:12px; box-shadow:0 2px 18px rgba(0,0,0,.12); z-index:9999; backdrop-filter:blur(4px);
    }
    .toolbar button { font-family:Arial,sans-serif; font-size:14px; padding:8px 14px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .toolbar button:hover { filter:brightness(.96); }
    @media (max-width:560px){ .toolbar{ top:8px; gap:6px; padding:6px 8px; } .toolbar button{ padding:6px 10px; font-size:13px; } }

    /* ======= PRINT STYLES ======= */
    @media print {
      @page { size:B5 portrait; margin:12mm; }
      html, body { background:none !important; margin:0 !important; padding:0 !important; }
      .toolbar { display:none !important; }
      .b5-preview { width:100%; margin:0; padding:0; box-shadow:none; box-sizing:border-box; transform:scale(0.97); transform-origin:top left; }
      table { width:100%; }
      .no-print { display:none !important; } .print-text { display:inline !important; }
      table input, table input[type="date"], .td-measure-grid input { border:none !important; outline:none !important; background:transparent !important; box-shadow:none !important; border-radius:0 !important; }
      .signature-box img[src=""] { display:none !important; }
      .stamp-box-row, .signature-box { display:flex !important; }
      * { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    }

    .td-measure-grid input.invalid { background:#ffebee; box-shadow:inset 0 0 0 1px #d32f2f; }
    @media print { .td-measure-grid input.invalid { background:transparent !important; box-shadow:none !important; } }

    /* Tengah untuk header + baris pertama data */
    .inspect-table tr:nth-child(-n+1) th,
    .inspect-table tr:nth-child(-n+1) td { text-align: center !important; }

    /* ===== Serial No prefix UI ===== */
    .serial-wrap { display:grid; grid-template-columns:auto 1fr; align-items:center; gap:1mm; }
    .serial-prefix { white-space:nowrap; }
  </style>
</head>
<body>
  <!-- Toolbar: Print / NAS保存 / Clear -->
  <div class="toolbar">
    <button type="button" onclick="printViaPDF()">🖨️ 印刷</button>
    <button type="button" onclick="saveToNASFixed()">💾 NAS保存</button>
    <button type="button" onclick="clearAllFields()">🧹 全てクリア</button>
  </div>

  <form id="inspection-form">
    <div class="b5-preview">
      <h2>出荷検査成績書</h2>

      <!-- HEADER TABLE -->
      <table class="header-table">
        <tr>
          <td class="section-label">客先</td>
          <td style="width:25%;">オークマ株式会社 殿</td>
          <td class="section-label">発行No.</td>
          <td><input type="text" name="customer_no" placeholder="例: TTS60-01-460" /></td>
          <td class="section-label">発行年月日</td>
          <td>
            <input type="date" name="hakkohiduke" class="no-print" />
            <span class="print-text" data-from="hakkohiduke"></span>
          </td>
        </tr>
        <tr>
          <td class="section-label">機種</td><td>MB-46V</td>
          <td class="section-label">品番</td>
          <td>H1090-0021-02-5</td>
          <td class="section-label">図番</td><td>2825-20</td>
        </tr>
        <tr>
          <td class="section-label">品名</td><td>Y軸SG</td>
          <td class="section-label">製造日</td>
          <td>
            <input type="date" name="makingdate" class="no-print" />
            <span class="print-text" data-from="makingdate"></span>
          </td>
          <td class="section-label">製造No</td>
          <td>
            <!-- Prefix tetap + input lanjutan; saat cetak tampil sebagai text -->
            <div class="serial-wrap no-print">
              <span class="serial-prefix">Y282520-</span>
              <input type="text" name="serial_no_suffix" inputmode="numeric" placeholder="例: 2245" />
            </div>
            <span class="print-text" data-serial-print></span>
          </td>
        </tr>
        <tr class="order-no-row">
          <td class="section-label">オーダーNo</td>
          <td class="data" colspan="5"><input type="text" name="order_no" placeholder="例: 102P068219-001" /></td>
        </tr>
      </table>

      <!-- INPUTTER -->
      <div class="inputter-row no-print">
        <label>入力者</label>
        <select name="inputter">
          <option value="">- 選択してください -</option>
          <option value="長谷部">長谷部</option>
          <option value="都合">都合</option>
          <option value="石橋">石橋</option>
        </select>
      </div>

      <!-- INSPECTION ITEMS -->
      <table>
        <tr><th>検査項目</th><th>規格</th><th>判定</th></tr>
        <tr>
          <td>本体取付け寸法</td><td>組立架台取付合わせ確認</td>
          <td>
            <select name="judge1" class="no-print judge-select"><option>合</option><option>否</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
        <tr>
          <td>摺動テスト</td><td>摺動テスト台走り・機能確認</td>
          <td>
            <select name="judge2" class="no-print judge-select"><option>合</option><option>否</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
        <tr>
          <td>摺動時の異音</td><td>異音の有無確認</td>
          <td>
            <select name="judge3" class="no-print judge-select"><option>無</option><option>有</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
        <tr>
          <td>外観検査</td><td>キズ・バリの有無確認</td>
          <td>
            <select name="judge4" class="no-print judge-select"><option>合</option><option>否</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
        <tr>
          <td>カバーワイパーの除隅</td><td>ワイパー材 t=0.05にて確認</td>
          <td>
            <select name="judge5" class="no-print judge-select"><option>合</option><option>否</option></select>
            <span class="print-text"></span>
          </td>
        </tr>
      </table>

      <!-- MEASUREMENTS -->
      <table>
        <tr><th>項目</th><th>基準値</th><th>測定値</th></tr>
        <tr>
          <td>収縮時長さ(a)</td>
          <td>190 mm以下</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="numeric" name="a_length" placeholder="0-190" data-min="0" data-max="190" />
              <span>mm</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>伸長時長さ(b)</td>
          <td>670 mm以上</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="numeric" name="b_length" placeholder=">=670" data-min="670" />
              <span>mm</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>カバーストローク(s)</td>
          <td>480 mm以上</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="numeric" name="c_length" placeholder=">=480" data-min="480" />
              <span>mm</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>初期摺動抵抗</td>
          <td>4.0 kg以下</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="decimal" step="0.1" name="start_resist" placeholder="0-4.0" data-min="0" data-max="4" />
              <span>kg</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>中期摺動抵抗</td>
          <td>4.0 kg以下</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="decimal" step="0.1" name="mid_resist" placeholder="0-4.0" data-min="0" data-max="4" />
              <span>kg</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>終期摺動抵抗</td>
          <td>4.0 kg以下</td>
          <td class="td-measure">
            <div class="td-measure-grid">
              <input type="text" inputmode="decimal" step="0.1" name="end_resist" placeholder="0-4.0" data-min="0" data-max="4" />
              <span>kg</span>
            </div>
          </td>
        </tr>
      </table>

      <!-- FINAL JUDGMENT & REMARKS -->
      <div style="margin:2mm 0;">
        <label style="font-weight:bold;">総合判定</label>
        <select name="final_judgment" class="no-print judge-select" style="margin-left:20mm;">
          <option>合格</option><option>否</option>
        </select>
        <span class="print-text"></span>
      </div>
      <div style="margin:2mm 0;">
        <label style="font-weight:bold;">[備考]</label>
        <input type="text" name="bikou" value="2821-20の追加加工" style="width:70%;" />
      </div>

      <!-- COMPANY & STAMPS -->
      <div class="company-name">東京精密発條株式会社</div>
      <div class="stamp-box-row">
        <div>
          <select class="no-print" onchange="updateStampPreview('stamp1',this.value)">
            <option value="">- 印鑑選択 -</option>
            <option value="nakagawa.png">中川部長</option>
            <option value="hasebe.png">長谷部</option>
            <option value="ishibashi.png">石橋</option>
            <option value="togo.png">都合</option>
            <option value="wahyu.png">ワーユ</option>
            <option value="yusuf.png">ユスフ</option>
          </select>
          <div class="stamp-label">検印</div>
          <div class="signature-box"><img id="stamp1" src="" alt=""></div>
        </div>
        <div>
          <select class="no-print" onchange="updateStampPreview('stamp2',this.value)">
            <option value="">- 印鑑選択 -</option>
            <option value="nakagawa.png">中川部長</option>
            <option value="hasebe.png">長谷部</option>
            <option value="ishibashi.png">石橋</option>
            <option value="togo.png">都合</option>
            <option value="wahyu.png">ワーユ</option>
            <option value="yusuf.png">ユスフ</option>
          </select>
          <div class="stamp-label">検査印</div>
          <div class="signature-box"><img id="stamp2" src="" alt=""></div>
        </div>
      </div>
    </div>
  </form>

  <script>
    function updateStampPreview(id, src) { document.getElementById(id).src = src || ''; }
    function clearAllFields() {
      const form = document.getElementById('inspection-form');
      form.reset();
      ['stamp1','stamp2'].forEach(id => document.getElementById(id).src = '');
      form.querySelectorAll('.td-measure-grid input.invalid').forEach(el => el.classList.remove('invalid'));
      wireJudgeMirror(); wireDateMirror(); wireEnterNavigationAll(); wireSerialMirror();
    }
    document.getElementById('clearAllBtn')?.addEventListener('click', clearAllFields);

    // ===== Validasi field numeric/decimal =====
    (function wireMeasureValidation() {
      const fields = document.querySelectorAll('.td-measure-grid input');
      const normalize = s => s.replace(/[，,]/g,'.').replace(/[．｡。]/g,'.');
      fields.forEach(inp=>{
        const allowDec = (inp.getAttribute('step')||'').includes('.');
        const MAX_INT_DIGITS = 4;
        inp.addEventListener('input',()=>{
          let v = normalize(inp.value).replace(/[^\d.]/g,'');
          if((v.match(/\./g)||[]).length>1){ const [h,...r]=v.split('.'); v=h+'.'+r.join('').replace(/\D/g,''); }
          if(v.includes('.')){ let[d='',f='']=v.split('.'); d=d.slice(0,MAX_INT_DIGITS);
            v = allowDec ? (f===''?`${d}.`:`${d}.${(f||'').replace(/\D/g,'').slice(0,1)}`) : d;
          } else v=v.slice(0,MAX_INT_DIGITS);
          inp.value=v; inp.classList.remove('invalid');
        });
        inp.addEventListener('blur',()=>{
          let v = normalize(inp.value);
          if(v===''){ inp.classList.remove('invalid'); return; }
          if(allowDec && /\.$/.test(v)) v=v.replace(/\.$/,'.0');
          const n=parseFloat(v), min=parseFloat(inp.dataset.min ?? '-Infinity'), max=parseFloat(inp.dataset.max ?? 'Infinity');
          const ok=!Number.isNaN(n)&&n>=(Number.isFinite(min)?min:-Infinity)&&n<=(Number.isFinite(max)?max:Infinity);
          if(!ok){ inp.value=''; inp.classList.add('invalid'); return; }
          inp.value = allowDec ? n.toFixed(1).replace(/\.0$/,'.0') : String(Math.trunc(n)).slice(0,4);
          inp.classList.remove('invalid');
        });
      });
    })();

    // ===== Enter navigation =====
    function wireEnterNavigationAll() {
      const form=document.getElementById('inspection-form');
      const getFields=()=>Array.from(form.querySelectorAll('input, select, textarea')).filter(el=>!el.disabled && el.type!=='hidden' && el.offsetParent!==null);
      const move=(from,dir=+1)=>{const list=getFields(); const i=list.indexOf(from); if(i===-1) return; let j=i+dir; if(j>=list.length) j=0; if(j<0) j=list.length-1; const next=list[j]; next?.focus?.(); if(next && next.tagName==='INPUT' && !['checkbox','radio','file'].includes(next.type)) next.select?.();};
      getFields().forEach(el=>{
        if(el.dataset.enterNavWired==='1') return; el.dataset.enterNavWired='1';
        el.addEventListener('keydown',e=>{ if(e.isComposing||e.keyCode===229) return; if(e.key==='Enter'){ e.preventDefault(); move(el,e.shiftKey?-1:+1);} });
      });
    }

    // ===== Mirror date & 判定 =====
    function wireDateMirror(){
      document.querySelectorAll('input[type="date"]').forEach(inp=>{
        const span=document.querySelector(`.print-text[data-from="${inp.name}"]`); if(!span) return;
        const fmt=v=>v?v.replace(/(\d{4})-(\d{2})-(\d{2})/,'$1/$2/$3'):''; const upd=()=>span.textContent=fmt(inp.value);
        inp.addEventListener('change',upd); upd();
      });
    }
    function wireJudgeMirror(){
      document.querySelectorAll('select.judge-select').forEach(sel=>{
        if(!sel.nextElementSibling || !sel.nextElementSibling.classList.contains('print-text')){
          const span=document.createElement('span'); span.className='print-text'; sel.parentNode.insertBefore(span, sel.nextSibling);
        }
        const span=sel.nextElementSibling; const upd=()=>span.textContent=sel.value; sel.addEventListener('change',upd); upd();
      });
    }

    /* ===== Serial No (prefix tetap + suffix operator) ===== */
    const getSerialFull = () => {
      const p = document.querySelector('.serial-prefix')?.textContent || '';
      const s = (document.querySelector('input[name="serial_no_suffix"]')?.value || '').replace(/[^\d]/g,'').trim();
      return s ? (p + s) : p;
    };
    function wireSerialMirror() {
      const out = document.querySelector('[data-serial-print]');
      const inp = document.querySelector('input[name="serial_no_suffix"]');
      if (!out) return;
      const upd = () => { out.textContent = getSerialFull(); };
      inp?.addEventListener('input', upd);
      upd();
    }

    // ===== Render canvas untuk PDF =====
    async function renderFormCanvas() {
      const el=document.querySelector('.b5-preview');
      return html2canvas(el,{
        scale:2, backgroundColor:'#FFFFFF', useCORS:true,
        onclone:(doc)=>{ doc.querySelectorAll('.no-print').forEach(e=>e.style.display='none'); doc.querySelectorAll('.print-text').forEach(e=>e.style.display='inline'); }
      });
    }

    /* ===== Nama file & builder PDF ===== */
    const sanitize = s => (s||'').replace(/[\\/:*?"<>|]/g,'').trim();
    function computeFilename(){
      const md=document.querySelector('input[name="makingdate"]').value;
      const ymd = md ? md.replace(/-/g,'') : (()=>{const t=new Date(); return t.getFullYear()+String(t.getMonth()+1).padStart(2,'0')+String(t.getDate()).padStart(2,'0');})();
      const customer = sanitize(document.querySelector('.header-table tr:nth-child(1) td:nth-child(2)')?.textContent || 'no-customer');
      const zuban    = sanitize(document.querySelector('.header-table tr:nth-child(2) td:nth-child(6)')?.textContent || 'no-zuban');
      const inputter = sanitize(document.querySelector('select[name="inputter"]')?.value || 'no-name');
      const orderNo  = sanitize(document.querySelector('input[name="order_no"]')?.value || 'no-order');
      const serialNo = sanitize(getSerialFull() || 'no-serial'); // pakai prefix+suffix
      return `${ymd}_${customer}_${zuban}_${inputter}_${orderNo}_${serialNo}.pdf`;
    }
    async function buildPdfDoc(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'b5' });
      const canvas = await renderFormCanvas();
      doc.addImage(canvas.toDataURL('image/png'), 'PNG', 7, 7, 162, 236);
      return doc;
    }

    /* ===== Print (tanpa header/footer browser) ===== */
    async function printViaPDF(){
      const doc = await buildPdfDoc();
      if(doc.autoPrint) doc.autoPrint();
      const blobUrl = doc.output('bloburl');
      window.open(blobUrl, '_blank');
    }

    /* ===== Save ke NAS (File System Access + IndexedDB) ===== */
    const DB_NAME='form-folder-db', STORE='folders'; let __db;
    const FIXED_KEY='Okuma_MB-46V'; // label tujuan (ganti jika perlu)

    function openDB(){ return new Promise((resolve,reject)=>{ const req=indexedDB.open(DB_NAME,1);
      req.onupgradeneeded=()=>req.result.createObjectStore(STORE);
      req.onsuccess=()=>{ __db=req.result; resolve(); };
      req.onerror=()=>reject(req.error);
    });}
    async function openDBIfNeeded(){ if(!__db) await openDB(); }
    async function putHandle(key, handle){ await openDBIfNeeded(); return new Promise((res,rej)=>{ const tx=__db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(handle,key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    async function getHandle(key){ await openDBIfNeeded(); return new Promise((res,rej)=>{ const tx=__db.transaction(STORE,'readonly'); const r=tx.objectStore(STORE).get(key); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }); }

    async function saveToNASFixed(){
      const fileName = computeFilename();

      if(!window.showDirectoryPicker){
        const doc = await buildPdfDoc(); doc.save(fileName); return;
      }

      try{
        let dir = await getHandle(FIXED_KEY);
        if(!dir){
          dir = await window.showDirectoryPicker({ mode:'readwrite' });
          await navigator.storage?.persist?.();
          await putHandle(FIXED_KEY, dir);
        }

        let perm = await dir.queryPermission?.({ mode:'readwrite' });
        if(perm!=='granted'){
          perm = await dir.requestPermission?.({ mode:'readwrite' });
          if(perm!=='granted'){ const doc = await buildPdfDoc(); doc.save(fileName); return; }
        }

        const doc = await buildPdfDoc();
        const fh = await dir.getFileHandle(fileName, { create:true });
        const w = await fh.createWritable();
        await w.write(doc.output('blob')); await w.close();
        alert(`Tersimpan ke NAS: ${fileName}`);
      }catch(e){
        console.error('Gagal tulis NAS; fallback ke Download.', e);
        const doc = await buildPdfDoc(); doc.save(fileName);
      }
    }

    // init
    window.addEventListener('load', () => {
      wireJudgeMirror(); wireDateMirror(); wireEnterNavigationAll(); wireSerialMirror();
    });
  </script>
</body>
</html>

